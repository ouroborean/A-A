name: Python package

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      # You can use PyPy versions in python-version.
      # For example, pypy-2.7 and pypy-3.8
      matrix:
        python-version: ["3.9", "3.10"]

    steps:
      - uses: actions/checkout@v3

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v0.4.0'
        with:
          workload_identity_provider: 'projects/${{ secrets.SERVER_ACCT_NO }}/locations/global/workloadIdentityPools/git-workflow/providers/git-workflow'
          service_account: 'git-workflow-account@${{ secrets.SERVER_ID }}.iam.gserviceaccount.com'
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      # You can test your matrix by printing the current Python version
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
      - name: Install pytest
        run: pip install pytest pytest-cov
      - name: Install project
        run: pip install -e .
      - name: Get resource tar file
        run: gcloud storage cp gs://a-a-resources/resources-2022-10-08.tar.gz src/animearena
      - name: Remove old resource directory
        run: rm -r resources
      - name: Unpack resources into resource folder
        run: tar -xvf src/animearena/resources-2022-10-08.tar.gz -C src/animearena
      - name: Run tests
        run: pytest tests/animearena_test.py --junitxml=junit/test-results.xml --cov=com --cov-report=xml --cov-report=html
